services:
  md-server:
    build: .
    image: md-server:latest
    restart: unless-stopped
    networks:
    - backend
    volumes:
    - ./www:/www:ro
    environment:
      RUST_LOG: md_server=info,tower_http=info
    read_only: true
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    init: true
    tmpfs:
    - /tmp
    pids_limit: 256
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'
    healthcheck:
      test:
      - CMD-SHELL
      - wget -qO- http://127.0.0.1:3000/healthz >/dev/null 2>&1
      interval: 10s
      timeout: 2s
      retries: 3
      start_period: 5s
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
    - 80:80
    - 443:443
    - 443:443/udp
    networks:
    - edge
    - backend
    volumes:
    - ./Caddyfile:/etc/caddy/Caddyfile:ro
    - caddy_data:/data
    - caddy_config:/config
    read_only: true
    tmpfs:
    - /tmp
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    cap_add:
    - NET_BIND_SERVICE
    pids_limit: 256
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'
    depends_on:
      md-server:
        condition: service_healthy
    environment:
      DOMAIN: ${DOMAIN:-localhost}
volumes:
  caddy_data: null
  caddy_config: null
networks:
  edge:
    driver: bridge
  backend:
    driver: bridge
    internal: true
